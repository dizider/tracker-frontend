<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
    <!-- <script src="https://apis.google.com/js/platform.js" async defer></script> -->
    <link rel="stylesheet" href="main.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script type="text/javascript" src="https://api.mapy.cz/loader.js"></script>
    <script type="text/javascript">Loader.load()</script>
    <script type="text/javascript" src="main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <title>Tracker</title>
</head>

<body>
    <noscript>
        You need to enable JavaScript to run this app.
    </noscript>
    <div id='app'></div>

    <script type="text/javascript">
        document.body.style.backgroundColor = '#080710';

        const rootNode = document.getElementById('app')
        /* Fetch back generated bytes from the local storage */
        function rememberedBytes() {
            const bytes = localStorage.getItem("bytes");
            return bytes ? bytes.split(",").map(x => parseInt(x, 10)) : null;
        }

        function persistedToken() {
            const token = localStorage.getItem("token")
            return token ? token : null;
        }

        const app = Elm.Main.init({
            node: rootNode,
            flags: {
                clientId: "***REMOVED***", //process.env.CLIENT_ID,
                state: rememberedBytes(),
                token: persistedToken()
            }
        });

        customElements.define('seznam-maps', class extends HTMLElement {
            constructor() {
                super();
            }

            connectedCallback() {
                console.log("Map is loading");
                this._screen = document.createElement('div');
                this._screen.setAttribute("id", "map");
                this._screen.style.height = this.getAttribute('height');
                this._screen.style.width = this.getAttribute('width');
                this.appendChild(this._screen);

                Loader.load();
                var center = SMap.Coords.fromWGS84(14.41790, 50.12655);
                this._map = new SMap(JAK.gel(this._screen), center, 13);
                this._map.addDefaultLayer(SMap.DEF_BASE).enable();
                this._map.addDefaultControls();
            }

            reload() {
                Loader.load();
                var center = SMap.Coords.fromWGS84(14.41790, 50.12655);
                this._map = new SMap(JAK.gel(this._screen), center, 13);
                this._map.addDefaultLayer(SMap.DEF_BASE).enable();
                this._map.addDefaultControls();
            }
        });

        /* Generate high entropy random bytes using the Web Crypto API and
        remember them so that they are preserved between redirections. This
        allows to protect for XSS & authorization code attacks */
        app.ports.genRandomBytes.subscribe(n => {
            const buffer = new Uint8Array(n);
            crypto.getRandomValues(buffer);
            const bytes = Array.from(buffer);
            localStorage.setItem("bytes", bytes);
            app.ports.randomBytes.send(bytes);
        });

        app.ports.persistToken.subscribe(token => {
            console.log("Persisting token")
            localStorage.setItem("token", token)
        });

        app.ports.removeToken.subscribe(_ => {
            console.log("Removing token")
            localStorage.removeItem("token")
        });

        app.ports.reloadMap.subscribe(message => {
            let elem = document.getElementById('maps')
            console.log(elem)
            elem.reload()
        });
    </script>
</body>

</html>